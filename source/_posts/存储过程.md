---
title: 存储过程
date: 2019-08-05 10:58:11
tags:
- ORACLE
- 存储过程
---

# 存储过程与存储函数

## 解释

储存程序 (Stored Procedure)，又可称预储程序或者存储过程，是一种在数据库中存储复杂程序，以便外部程序调用的一种数据库对象，它可以视为数据库中的一种函数或子程序。

`存储在数据库中，供所有用户程序调用的子程序`

- 优点
    1. 重复使用。存储过程可以重复使用，从而可以减少数据库开发人员的工作量。
    2. 减少网络流量。存储过程位于服务器上，调用的时候只需要传递存储过程的名称以及参数就可以了，因此降低了网络传输的数据量。
    3. 安全性。参数化的存储过程可以防止SQL注入式攻击，而且可以将Grant、Deny以及Revoke权限应用于存储过程。
    4. 效率高。由于数据库执行动作时，是先编译后执行的。然而存储过程是一个编译过的代码块，所以执行效率要比T-SQL语句高。

- 缺点
    1. 调试麻烦。
    2. 移植性差。不同数据库支持的语言不一样，其存储过程的编写规则也不一样，所以存储过程无法移植到另一类数据库。
    3. 重新编译问题。因为后端代码是运行前编译的，如果带有引用关系的对象发生改变时，受影响的存储过程、包将需要重新编译（不过也可以设置成运行时刻自动编译）。
    4. 不能大量使用。如果在一个程序系统中大量的使用存储过程，到程序交付使用的时候随着用户需求的增加会导致数据结构的变化，接着就是系统的相关问题了，最后如果用户想维护该系统可以说是非常难、而且代价是空前的，维护起来更麻烦。

## 存储过程语法


### 语法
    create [or replace] procedure  <过程名>(<参数列表,无参时忽略>)
    as/is
    变量声明、初始化
    begin
    业务处理、逻辑代码
    exception
    异常捕获、容错处理
    end  <过程名>;

    参数:
    <参数名> in|out|in out  <参数类型，无长度说明> ，如：v_name  varchar2
    in：入参
    out：出参
    in out：出入参

    调用语法：
        1)、exec  <过程名>;
        2)、execute  <过程名>;
        3)、在PL/SQL语句块中直接调用。

    异常捕获：
        when others then/raise;
### 示例

    create or replace procedure "TEST_SWAP"(v_param1 in out varchar2,v_param2 in out varchar2)
    is
        v_temp varchar2(20);
    begin
        dbms_output.put_line('交换前参数1：'||v_param1||'  参数2：'||v_param2);
        v_temp:=v_param1;
        v_param1:=v_param2;
        v_param2:=v_temp;
        dbms_output.put_line('交换后参数1：'||v_param1||'  参数2：'||v_param2);
    exception
        when others then dbms_output.put_line('There is a error when the procedure up_wap executing!');
    end "TEST_SWAP";

### 常用语法

    -- INSERT
    SELECT INTO table1 (name1, name2...) SELECT (name1, name2..) FROM table2 WHERE exprss

    -- 转换为两位小数
    SELECT to_char('1111','FM990.00') FROM hau_dm_b6c_import;

    -- NVL(E1, E2)的功能为：如果E1为NULL，则函数返回E2，否则返回E1本身。
    SELECT NVL('1233', '123') FROM HAU_DM_B6C_IMPORT;


## 存储函数语法

    -- 语法
    create [or replace] function 函数名(参数列表)
    return 函数值类型
    as
    PLSQL子程序体;


## 使用原则
如果只有一个返回值,用存储函数;否则,就用存储过程.


# HiAgent 报表

## 配置数据源管理

视作一个在页面上定义一个存储过程

1. 位置：系统配置中心->报表->数据源管理

2. 添加数据源：
   - 存储过程名称：数据库中对应的名称
   - 数据源名称：
   - 数据源描述：

3. 配置输入和输出参数

## 配置模版管理

定义其展现模式

1. 位置：系统配置中心->报表->模版管理

2. 添加模版：（前端使用echart控件）
    - 模版名称：
    - 模版描述：
    - 模版类：
    - 存储过程：上一级定义的过程
    - 模版类型：
        - 图表：需要配置模版样式
        - 网格：要求展现的字段为num

## 配置报表管理

定义其具体的输入内容和暂时内容

1. 位置：系统配置中心->报表->报表管理

2. 添加报表：
    - 报表标题：
    - 模版子标题：
    - 报表类：同上一级配置的模版类型（无法更改）
    - 报表模版：

## 配置权限管理

定义什么角色可以查看

BUG：全选按钮会导致无法查看报表，需要逐个勾选




