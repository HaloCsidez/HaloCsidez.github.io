---
title: 左右值编码树
date: 2020-02-28 16:20:19
tags:
- JAVA
- 数据结构
- 数据库
---

公司侧边栏数据展开很慢，查看代码后发现前辈是用父子结构递归解析侧边栏数据树的。想到自己先前的一个项目也是这样实现，当时在数据量很少的情况中没发现问题，然而在数据达到800多就导致后端数据梳理慢，前端渲染慢点问题。

- 传统树状结构设计的问题

  id｜value｜parentId｜key｜level 

  (根据业务情况可适当加一些parent_path之类的冗余字段提升性能，降低查询编码复杂度)

  这种结构在数据层级叫少的情况下是比较好的设计方案且结构简单易懂，但是一旦数据层级多了查询就会成问题，需要频繁递归操作，递归过程需要不断访问数据库。很难快速的查找某个节点下所有子节点，或者查询这个节点的族谱路径并且把数据查出来以后撮合成树状结构也需要花费很多时间。

- 传统树状结构设计的问题

  id｜leftId｜rightId｜value｜level（可以加parentId）

  而左右值编码树有高效的数据查询性能，数据存储冗余度小。

  ![download](https://csidezyum.oss-cn-hangzhou.aliyuncs.com/blogImg/download.jpg)

1. 获得B节点的子孙节点（寻找leftId或者rightId在2和13之间的节点）

   > SELECT* FROM Tree WHERE Lft BETWEEN 2 AND 13 ORDER BY Lft ASC

2. 计算子孙节点的个数

   子孙总数 = (右值 – 左值– 1) / 2

3. 计算当前节点所在层次（leftId小于等于2并且rightId大于等于13的个数就是他的层数）

   > SELECT COUNT(*) FROM Tree WHERE Lft <= 2 AND Rgt >=13

4. 新增一个节点

   该节点的后续节点的rightId自增2

   ![download](https://csidezyum.oss-cn-hangzhou.aliyuncs.com/blogImg/download-1.jpg)